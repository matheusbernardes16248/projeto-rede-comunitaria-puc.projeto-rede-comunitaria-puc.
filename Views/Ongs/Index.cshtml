@using System.Security.Claims;
@using X.PagedList.Mvc.Core;
@model X.PagedList.IPagedList<nexumApp.Models.Ong>;

@{
    ViewData["Title"] = "Ongs cadastradas";
    var currentPage = Model.PageCount < Model.PageNumber ? 0 : Model.PageNumber;
    string userId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var tags = new Tags().TagsNames;
}

<link rel="stylesheet" href="~/css/ongsIndex.css" />
<div class="ONGS-container">
<div class="ONGS-filter">
    <h2 class="ONGS-filter-title">Filtrar ONGS</h2>
    <div class="ONGS-filter-chips-container">
        <h5>Causas:</h5>
        @for(int index = 0; index < tags.Count; index++) {
            <span class="ONGS-filter-chip" id="@index">@tags[index]</span>
        }
    </div>
    <button id="ONGS-filter-submit">Filtrar</button>
</div>

<div class="ONGS-page-content">
@if(@Model.Count == 0) {
    <h4 class="ONGS-empty">Oops.. Nada encontrado :(</h4>
}
else {
<h1 class="ONGS-title">ONGs cadastradas</h1>
<h4 class="ONGS-subtitle">@ViewBag.Total ONGs</h4>


<div class="ONGS-flex-container">
@foreach (var item in Model)
{
    var tagId = item.Tag.GetValueOrDefault();

    <div class="ONGS-flex-container-item">

        <!-- PARTE CLICÁVEL (somente infos) -->
        <a class="ONGS-flex-container-item-link"
           asp-action="Details"
           asp-route-id="@item.Id">
            <div class="ONGS-flex-container-item-img">
                <img class="ONGS-flex-container-item-img-src" src="@item.ImageURL" alt="@item.Nome" />
            </div>

            <h5>@item.Nome</h5>
            <span class="ONGS-flex-container-tag">@ViewBag.Tags[tagId]</span>
            <p class="ONGS-flex-container-item-endereço">@item.Endereço</p>
            <p class="ONGS-flex-container-item-descriçao">@item.Descriçao</p>
        </a>

        @* BOTÕES APENAS PARA ADMIN *@
        @if (User.IsInRole("Admin"))
        {
            <div class="ONGS-flex-container-item-actions">
                <form asp-action="ToggleStatus" asp-route-id="@item.Id" method="post">
                    <button type="submit" class="@(item.Aprovaçao ? "btn-ong-pausar" : "btn-ong-reativar")">
                        @(item.Aprovaçao ? "Pausar ONG" : "Reativar ONG")
                    </button>
                </form>

                <span class="status-badge @(item.Aprovaçao ? "status-ativa" : "status-inativa")">
                    @(item.Aprovaçao ? "Ativa" : "Inativa")
                </span>
            </div>
        }
    </div>
}
</div>

/*<div class="ONGS-flex-container">
@foreach (var item in Model)
{
    var tagId = item.Tag.GetValueOrDefault();

  <div class="ONGS-flex-container">
@foreach (var item in Model) {
    var tagId = item.Tag.GetValueOrDefault();
    <a class="ONGS-flex-container-item" asp-action="Details" asp-route-id="@item.Id">
        <div class="ONGS-flex-container-item-img">
            <img class="ONGS-flex-container-item-img-src" src="@item.ImageURL">
        </div>
        <h5>@Html.DisplayFor(modelItem => item.Nome)</h5>
        <span class="ONGS-flex-container-tag">@ViewBag.Tags[tagId]</span>
        <p class="ONGS-flex-container-item-endereço">@Html.DisplayFor(modelItem => item.Endereço)</p>
        <p class="ONGS-flex-container-item-descriçao">@Html.DisplayFor(modelItem => item.Descriçao)</p>
    </a>
}
</div>*/

<span>Página @currentPage de @Model.PageCount</span>
<span>
    @Html.PagedListPager( Model, page => Url.Action("Index", new { page }), new PagedListRenderOptions()
    {
        LiElementClasses = new List<string> {"paginationItem"}
    })
</span>
}
</div>
</div>

@section Scripts {
    <script>
        const chips = document.getElementsByClassName("ONGS-filter-chip")
        const submitButton = document.getElementById("ONGS-filter-submit")
        let url = new URL(window.location.href);
        let params = url.searchParams;
        let existingParams = params.get("ONGtags")
        let ids = []

        if(existingParams) {
            const paramsArr = existingParams.split(",")
            ids = paramsArr
            console.log(paramsArr)
            paramsArr.map(id =>
                document.getElementById(id).classList.add("ONGS-filter-chip-selected")
            )
        }

        const selectChip = (chip) => {
            if(chip.classList.contains("ONGS-filter-chip-selected")) {
               ids = ids.filter(id => id !== chip.id)
               return chip.classList.remove("ONGS-filter-chip-selected")   
            }
            chip.classList.add("ONGS-filter-chip-selected")
            ids.push(chip.id)
        }

        for (let index = 0; index < chips.length; index++) {
            chips[index].addEventListener("click", () => {              
                selectChip(chips[index])
            })
        }

        submitButton.addEventListener("click", () => {
            const selectedChips = document.getElementsByClassName("ONGS-filter-chip-selected")
            params.delete("page")
            if(selectedChips.length) {
                params.set('ONGtags', ids);
                let updatedUrl = url.toString();
                return window.location.href = updatedUrl
            }
            if(!selectedChips.length) {
                params.delete("ONGtags")
                let updatedUrl = url.toString();
                return window.location.href = updatedUrl
            }
        })
    </script>
}
        