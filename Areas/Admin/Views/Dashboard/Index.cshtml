@model IEnumerable<nexumApp.Models.Ong>
@{
    ViewData["Title"] = "Dashboard do Admin";
}

<div class="admin-wrap">


    @if (TempData["Success"] is string ok && !string.IsNullOrWhiteSpace(ok))
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @ok
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @err
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    @if (TempData["Info"] is string info && !string.IsNullOrWhiteSpace(info))
    {
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            @info
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <h1 class="admin-hello">Olá, @User.Identity?.Name!</h1>


    <hr class="section-divider" />

    <section class="admin-section">
        <h3 class="admin-h3">Convidar novo administrador</h3>

        <form asp-area="Admin" asp-controller="ConviteAdmin" asp-action="CreateInvite" method="post" class="row gy-2 gx-2">
            @Html.AntiForgeryToken()
            <div class="col-auto">
                <input type="email" name="email" class="form-control" placeholder="email@exemplo.com" required />
            </div>
            <div class="col-auto">
                <button class="btn btn-primary admin-pill" type="submit">Gerar convite</button>
            </div>
        </form>
    </section>
    
    <hr class="section-divider" />

    <section class="admin-section">
        <h2 class="admin-h2">Cadastros pendentes de aprovação</h2>

        @if (!(Model?.Any() ?? false))
        {
            <div class="alert alert-success mt-3">Sem pendências no momento</div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table admin-table align-middle">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Endereço</th>
                            <th>CNPJ</th>
                            <th>Descrição</th>
                            <th class="text-end">Ações</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ong in Model!)
                        {
                            <tr>
                                <td>@ong.Nome</td>
                                <td>@ong.Endereço</td>
                                <td>@string.Format("{0:00\\.000\\.000\\/0000\\-00}", Convert.ToInt64(ong.CNPJ))</td>
                                <td>@ong.Descriçao</td>
                                <td class="text-end">
                                    <div class="d-flex gap-2 justify-content-end">
                                        <button type="button"
                                                class="btn btn-outline-primary btn-sm btn-visualizar"
                                                data-id="@ong.Id"
                                                data-nome="@ong.Nome"
                                                data-bs-toggle="modal"
                                                data-bs-target="#ongModal">
                                            Visualizar
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="modal fade" id="ongModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                Detalhes da ONG
                                <small class="text-muted d-block" id="ongModalSub"></small>
                            </h5>
                         
                        </div>

                        <div class="modal-body" id="ongModalBody">
                            <div class="text-center py-5" id="ongModalLoading">
                                Carregando...
                            </div>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                Fechar
                            </button>

                            <button type="button" class="btn btn-danger" id="btnReprovar" data-ong-id="">
                                Reprovar
                            </button>

                            <form id="formAprovar"
                                  asp-area="Admin"
                                  asp-controller="Dashboard"
                                  asp-action="Approve"
                                  method="post"
                                  class="d-inline">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" id="aprovarId" />
                                <button type="submit" class="btn btn-success">Aprovar</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="reprovarModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Motivo da reprovação</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>

                        <form asp-area="Admin"
                              asp-controller="Dashboard"
                              asp-action="Reject"
                              method="post"
                              id="formReprovar">
                            @Html.AntiForgeryToken()

                            <div class="modal-body">
                                <input type="hidden" name="id" id="reprovarOngId" />

                                <p>Selecione o(s) motivo(s) da reprovação:</p>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           name="motivos"
                                           id="motivo1"
                                           value="ENDEREÇO INCOMPLETO OU INEXISTENTE" />
                                    <label class="form-check-label" for="motivo1">
                                        Endereço incompleto ou inexistente
                                    </label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           name="motivos"
                                           id="motivo2"
                                           value="CNPJ INVÁLIDO" />
                                    <label class="form-check-label" for="motivo2">
                                        CNPJ inválido
                                    </label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           name="motivos"
                                           id="motivo3"
                                           value="DOCUMENTO DE COMPROVAÇÃO INCORRETO" />
                                    <label class="form-check-label" for="motivo3">
                                        Documento de comprovação incorreto
                                    </label>
                                </div>

                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"
                                           name="motivos"
                                           id="motivo4"
                                           value="DOCUMENTO DE COMPROVAÇÃO INLEGÍVEL" />
                                    <label class="form-check-label" for="motivo4">
                                        Documento de comprovação ilegível
                                    </label>
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        data-bs-dismiss="modal">
                                    Cancelar
                                </button>
                                <button type="submit" class="btn btn-danger">
                                    Reprovar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="text-center mt-2">
                <button class="btn btn-outline-secondary admin-pill-sm" type="button">Ver mais</button>
            </div>
        }
    </section>

    <hr class="section-divider" />

    <section class="admin-section">
        <h3 class="admin-h3">Administrar</h3>
        <div class="admin-chips">
            <a class="admin-chip-adm" asp-area="" asp-controller="Home" asp-action="QuemSomos">Quem somos</a>
            @{
                var unread = (int)(ViewBag.UnreadFale ?? 0);
            }
            <a class="admin-chip-adm"
               href='@Url.Action("Index", "FaleConosco", new { area = "Admin" })'
               id="btn-faleconosco">
                Fale conosco
                @if (unread > 0)
                {
                    <span class="chip-badge">@(unread > 99 ? "99+" : unread.ToString())</span>
                }
            </a>
        </div>
    </section>

    <hr class="section-divider" />

    <section class="admin-section">
        <h3 class="admin-h3">Relatórios</h3>

        <div class="admin-card">
            <div class="admin-card-title">Selecione abaixo as informações que deseja ver no relatório</div>

            <form id="frm-ongs-report" method="post"
                  asp-area="Admin" asp-controller="Relatorio" asp-action="OngsPdf">
                @Html.AntiForgeryToken()

                <div class="admin-chips selectable" id="cols-ongs">
                    <button type="button" class="admin-chip" data-col="nome">Nome Razão</button>
                    <button type="button" class="admin-chip" data-col="descricao">Descrições</button>
                    <button type="button" class="admin-chip" data-col="aprovacao">Status de aprovação</button>
                    <button type="button" class="admin-chip" data-col="cnpj">CNPJ</button>
                    <button type="button" class="admin-chip" data-col="email">E-mail</button>
                    <button type="button" class="admin-chip" data-col="filiais">Filiais</button>
                    <button type="button" class="admin-chip" data-col="metas">Metas</button>
                    <button type="button" class="admin-chip" data-col="vagas">Vagas</button>
                    <button type="button" class="admin-chip" data-col="doc">Documento de comprovação</button>
                    <button type="button" class="admin-chip" data-col="endereco">Endereço</button>
                </div>

                <div class="text-center mt-3">
                    <button class="btn btn-primary admin-pill" type="submit" id="btn-gerar-ongs">Gerar relatório</button>
                </div>
            </form>
        </div>
    </section>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/adminDashboard.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
}

@section Scripts {

    <script>

                 document.addEventListener('click', async (e) => {
            const btnVisualizar = e.target.closest('.btn-visualizar');
            if (btnVisualizar) {
                const id   = btnVisualizar.dataset.id;
                const nome = btnVisualizar.dataset.nome;

                const sub  = document.getElementById('ongModalSub');
                const body = document.getElementById('ongModalBody');

                // guarda ID pra reprovar
                const btnReprovar = document.getElementById('btnReprovar');
                if (btnReprovar) btnReprovar.dataset.ongId = id;

                // guarda ID no hidden do Aprovar
                const inputAprovar = document.getElementById('aprovarId');
                if (inputAprovar) inputAprovar.value = id;

                sub.textContent = nome || '';
                body.innerHTML = '<div class="text-center py-5">Carregando...</div>';

                try {
                    const url = '@Url.Action("PendingDetails", "Ongs", new { area = "Admin" })' + `?id=${id}`;
                    const resp = await fetch(url, {
                        headers: { 'X-Requested-With': 'XMLHttpRequest' }
                    });
                    if (!resp.ok) throw new Error('Erro ao carregar detalhes');

                    const html = await resp.text();
                    body.innerHTML = html;
                } catch (err) {
                    body.innerHTML = `<div class="alert alert-danger m-0">${err.message}</div>`;
                }
            }

            // abrir modal de motivos ao clicar em Reprovar
            const btnReprovarClick = e.target.closest('#btnReprovar');
            if (btnReprovarClick) {
                const idOng = btnReprovarClick.dataset.ongId;
                if (!idOng) return;

                document.getElementById('reprovarOngId').value = idOng;

                const ongModalEl = document.getElementById('ongModal');
                const ongModal   = bootstrap.Modal.getInstance(ongModalEl);
                if (ongModal) ongModal.hide();

                const reprovarModalEl = document.getElementById('reprovarModal');
                const reprovarModal   = new bootstrap.Modal(reprovarModalEl);
                reprovarModal.show();
            }
        });

        document.addEventListener('click', (e) => {
          // Botão "Visualizar PDF":
          const btnView = e.target.closest('.js-view-pdf');
          if (btnView) {
            const url = btnView.dataset.url;
            const wrap   = document.getElementById('pdfViewerWrap');
            const loader = document.getElementById('pdfLoader');
            const frame  = document.getElementById('pdfFrame');

            if (!wrap || !loader || !frame) return;

            wrap.style.display = 'block';
            loader.style.display = 'flex';
            frame.style.display = 'none';

            if (frame.src !== url) {
              frame.src = url;
            }

            frame.onload = function () {
              loader.style.display = 'none';
              frame.style.display = 'block';
            };
          }
        });
    </script>
    <script>
        (function () {
            async function atualizarBadgeFaleConosco() {
                try {
                    const resp = await fetch('@Url.Action("UnreadMessagesCount", "Dashboard", new { area = "Admin" })',
                                             { headers: { "X-Requested-With": "XMLHttpRequest" } });
                    if (!resp.ok) return;
                    const { count } = await resp.json();

                    const botao = document.getElementById('btn-faleconosco');
                    if (!botao) return;

                    let badge = botao.querySelector('.chip-badge');

                    if ((count ?? 0) > 0) {
                        if (!badge) {
                            badge = document.createElement('span');
                            badge.className = 'chip-badge';
                            botao.appendChild(badge);
                        }
                        badge.textContent = count > 99 ? '99+' : String(count);
                    } else if (badge) {
                        badge.remove();
                    }
                } catch (e) {
                }
            }

            atualizarBadgeFaleConosco();
            setInterval(atualizarBadgeFaleConosco, 30000);
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) atualizarBadgeFaleConosco();
            });
        })();
    </script>

    <script>

        //PDF:

        (function () {
          const chipsWrap = document.getElementById('cols-ongs');
          const form = document.getElementById('frm-ongs-report');

          chipsWrap?.addEventListener('click', (e) => {
            const chip = e.target.closest('.admin-chip[data-col]');
            if (!chip) return;
            chip.classList.toggle('selected');
          });

         
          form?.addEventListener('submit', (e) => {
            
            [...form.querySelectorAll('input[name="columns"]')].forEach(i => i.remove());

            const selected = [...chipsWrap.querySelectorAll('.admin-chip.selected')]
              .map(btn => btn.getAttribute('data-col'));

            if (selected.length === 0) {
              e.preventDefault();
              alert('Selecione pelo menos uma coluna.');
              return;
            }

            selected.forEach(col => {
              const input = document.createElement('input');
              input.type = 'hidden';
              input.name = 'columns';
              input.value = col;
              form.appendChild(input);
            });

          });
        })();
    </script>

}
